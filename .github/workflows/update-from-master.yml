on:
  schedule:
    - cron:  "0 6 * * *"
  workflow_dispatch:

name: Create PHP protobufs from latest Meshtastic Protobufs

jobs:
  update-from-master:
    name: Update from master
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Clone Meshtastic Protobufs repository
        uses: actions/checkout@v4
        with:
          repository: meshtastic/protobufs
          token: ${{ github.token }}
          path: ./protobufs
          fetch-depth: 0
          fetch-tags: true

      - name: Checkout Meshtastic Protobufs latest release tag
        run: |
          cd ./protobufs
          git reset --hard HEAD
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          git checkout $LATEST_TAG
          cd ..
          echo "LATEST_TAG=${LATEST_TAG}" >> "$GITHUB_ENV"
          echo "LATEST_TAG_NUMBER=${LATEST_TAG:1}" >> "$GITHUB_ENV"

      - name: Checkout current code
        uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ github.token }}
          path: ./php-code
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest tag of this repository
        run: |
          cd ./php-code
          git checkout master
          git reset --hard HEAD
          CURRENT_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          cd ..
          echo "CURRENT_TAG=${CURRENT_TAG}" >> "$GITHUB_ENV"
          echo "CURRENT_TAG_NUMBER=${CURRENT_TAG:1}" >> "$GITHUB_ENV"

      - name: Show working directory
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: ls -lash ./*

      - name: Install Protoc
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        uses: arduino/setup-protoc@v3

      - name: Check protoc is installed
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: which protoc

      - name: Create output directory
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: mkdir -p ./protobufs-output

      - name: Show working directory
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: ls -lash ./*

      - name: Convert the nanopb.proto file to proto3
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: |
          cd ./protobufs
          sed -i 's/proto2/proto3/g' ./nanopb.proto
          sed -i 's/ \[default = [^;]*//g' ./nanopb.proto
          sed -i 's/optional google.protobuf.FieldDescriptorProto/\/\/ optional google.protobuf.FieldDescriptorProto/g' ./nanopb.proto
          cd ..

      - name: Generate the PHP files from the protobufs
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: |
          cd ./protobufs
          find . -type f -iname '*.proto' -exec protoc --proto_path= --php_out=../protobufs-output {} \;
          cd ..

      - name: Replace the current protobuf PHP files with the ones we just generated
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: |
          rm -rf ./php-code/src/GPBMetadata
          rm -rf ./php-code/src/Meshtastic
          mv ./protobufs-output/GPBMetadata ./php-code/src/
          mv ./protobufs-output/Meshtastic ./php-code/src/

      - name: Commit and push changes
        if: env.LATEST_TAG_NUMBER > env.CURRENT_TAG_NUMBER
        run: |
          cd ./php-code
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Update protobufs to latest version"
          git push origin master
          git tag -a $LATEST_TAG -m "Update protobufs to latest version"
          git push --tags origin master

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master

      - name: get the latest release tag
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "LATEST_TAG=${LATEST_TAG}" >> "$GITHUB_ENV"

      - name: get the latest release tag
        run: |
          echo "Current TAG = ${{ env.LATEST_TAG }}"
          set +e
          if [[ "$(gh release view $LATEST_TAG 2>&1)" == "release not found" ]]; then
            echo "Release not found."
            echo "release-exists=false" >> $GITHUB_OUTPUT
          else
            echo "Release found."
            echo "release-exists=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Create Release
        id: create_release
        if: ! env.release-exists
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: ${{ env.LATEST_TAG }}
          release_name: Release ${{ env.LATEST_TAG }}
          body: |
            You can read the full changelog [here](https://github.com/meshtastic/protobufs/releases).

            Changelog for this version tag is [here](https://github.com/meshtastic/protobufs/releases/tag/${{ env.LATEST_TAG }})
          draft: false
          prerelease: false
